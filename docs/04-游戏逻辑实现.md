# 🎮 游戏逻辑实现

本章将实现猜数字游戏的核心逻辑，包括游戏主循环、随机数生成、用户交互等关键功能。

## 1. 随机数生成

### 理解随机数生成
```go
import (
    "math/rand"
    "time"
)

// 设置随机数种子
func initRandom() {
    rand.Seed(time.Now().UnixNano())
}

// 生成指定范围的随机数
func generateRandomNumber(min, max int) int {
    return rand.Intn(max-min+1) + min
}

// 示例：生成 1-100 之间的随机数
func generateTargetNumber() int {
    return generateRandomNumber(1, 100)
}
```

### 随机数种子的重要性
```go
// 不设置种子的问题演示
func badRandomExample() {
    for i := 0; i < 5; i++ {
        fmt.Println(rand.Intn(100) + 1)
    }
    // 每次运行程序都会产生相同的序列
}

// 正确的随机数生成
func goodRandomExample() {
    rand.Seed(time.Now().UnixNano()) // 使用当前时间作为种子
    for i := 0; i < 5; i++ {
        fmt.Println(rand.Intn(100) + 1)
    }
    // 每次运行程序都会产生不同的序列
}
```

## 2. 游戏主循环设计

### 游戏流程分析
```
开始游戏
    ↓
生成目标数字
    ↓
显示欢迎信息
    ↓
┌─→ 获取用户输入
│   ↓
│   验证输入
│   ↓
│   比较猜测与目标
│   ↓
│   显示反馈信息
│   ↓
│   增加猜测次数
│   ↓
│   检查是否猜对 ──→ 是：显示成功信息，结束游戏
│   ↓
└── 否：继续循环
```

### Start 方法实现
```go
// Start 开始游戏
func (g *Game) Start() {
    fmt.Println("欢迎来到猜数字游戏！")
    fmt.Println("我已经想好了一个 1-100 之间的数字，请开始猜测：")
    
    // 游戏主循环
    for {
        // 获取玩家猜测
        guess, err := g.getPlayerGuess()
        if err != nil {
            fmt.Printf("输入错误：%v，请重新输入。\n", err)
            continue // 输入错误时不增加猜测次数，继续循环
        }
        
        // 增加猜测次数
        g.attempts++
        
        // 检查猜测结果
        result := g.checkGuess(guess)
        
        // 根据结果给出反馈
        if result == 0 {
            // 猜对了，游戏结束
            fmt.Printf("恭喜你！猜对了！你总共猜了 %d 次。\n", g.attempts)
            break
        } else if result > 0 {
            fmt.Println("太大了！请再试一次。")
        } else {
            fmt.Println("太小了！请再试一次。")
        }
    }
}
```

## 3. 输入验证和错误处理

### 输入验证策略
```go
// getPlayerGuess 获取玩家的猜测输入
func (g *Game) getPlayerGuess() (int, error) {
    fmt.Print("请输入你的猜测：")
    
    // 第一层验证：读取输入是否成功
    if !g.scanner.Scan() {
        return 0, fmt.Errorf("读取输入失败")
    }
    
    // 第二层验证：输入是否为空
    input := strings.TrimSpace(g.scanner.Text())
    if input == "" {
        return 0, fmt.Errorf("输入不能为空")
    }
    
    // 第三层验证：是否为有效数字
    guess, err := strconv.Atoi(input)
    if err != nil {
        return 0, fmt.Errorf("请输入一个有效的数字")
    }
    
    // 第四层验证：数字是否在有效范围内
    if guess < 1 || guess > 100 {
        return 0, fmt.Errorf("数字必须在 1-100 之间")
    }
    
    return guess, nil
}
```

### 错误处理最佳实践
```go
// 定义常量错误信息
const (
    ErrEmptyInput    = "输入不能为空"
    ErrInvalidNumber = "请输入一个有效的数字"
    ErrOutOfRange    = "数字必须在 1-100 之间"
    ErrReadFailed    = "读取输入失败"
)

// 使用预定义错误
func (g *Game) getPlayerGuessImproved() (int, error) {
    fmt.Print("请输入你的猜测：")
    
    if !g.scanner.Scan() {
        return 0, fmt.Errorf(ErrReadFailed)
    }
    
    input := strings.TrimSpace(g.scanner.Text())
    if input == "" {
        return 0, fmt.Errorf(ErrEmptyInput)
    }
    
    guess, err := strconv.Atoi(input)
    if err != nil {
        return 0, fmt.Errorf(ErrInvalidNumber)
    }
    
    if guess < 1 || guess > 100 {
        return 0, fmt.Errorf(ErrOutOfRange)
    }
    
    return guess, nil
}
```

## 4. 游戏状态管理

### 比较算法实现
```go
// checkGuess 检查猜测结果
// 返回值：0 表示猜对，正数表示猜大了，负数表示猜小了
func (g *Game) checkGuess(guess int) int {
    switch {
    case guess == g.targetNumber:
        return 0  // 猜对了
    case guess > g.targetNumber:
        return 1  // 猜大了
    default:
        return -1 // 猜小了
    }
}

// 或者使用更直观的方式
func (g *Game) checkGuessVerbose(guess int) string {
    if guess == g.targetNumber {
        return "correct"
    } else if guess > g.targetNumber {
        return "too_high"
    } else {
        return "too_low"
    }
}
```

### 游戏反馈系统
```go
// provideFeedback 根据比较结果提供反馈
func (g *Game) provideFeedback(result int) {
    switch result {
    case 0:
        fmt.Printf("🎉 恭喜你！猜对了！你总共猜了 %d 次。\n", g.attempts)
    case 1:
        fmt.Println("📈 太大了！请再试一次。")
    case -1:
        fmt.Println("📉 太小了！请再试一次。")
    }
}

// 带有更详细反馈的版本
func (g *Game) provideFeedbackDetailed(guess, result int) {
    switch result {
    case 0:
        fmt.Printf("🎉 恭喜你！猜对了！答案就是 %d，你总共猜了 %d 次。\n", 
                   guess, g.attempts)
    case 1:
        fmt.Printf("📈 %d 太大了！目标数字比这个小。\n", guess)
    case -1:
        fmt.Printf("📉 %d 太小了！目标数字比这个大。\n", guess)
    }
}
```

## 5. 多轮游戏支持

### 继续游戏询问
```go
// askContinue 询问是否继续游戏
func askContinue() bool {
    scanner := bufio.NewScanner(os.Stdin)
    
    for {
        fmt.Print("是否继续游戏？(y/n)：")
        
        if !scanner.Scan() {
            fmt.Println("读取输入失败，默认退出游戏。")
            return false
        }
        
        input := strings.ToLower(strings.TrimSpace(scanner.Text()))
        
        switch input {
        case "y", "yes", "是", "继续":
            return true
        case "n", "no", "否", "退出":
            return false
        default:
            fmt.Println("请输入 y(是) 或 n(否)。")
        }
    }
}
```

### 主程序循环
```go
// main 主函数
func main() {
    // 显示游戏标题
    fmt.Println(strings.Repeat("=", 50))
    fmt.Println("🎯 Go 语言猜数字游戏")
    fmt.Println(strings.Repeat("=", 50))

    // 游戏主循环
    for {
        // 创建新游戏实例
        game := NewGame()
        
        // 开始游戏
        game.Start()

        // 询问是否继续
        if !askContinue() {
            fmt.Println("感谢游戏！再见！👋")
            break
        }

        // 显示新游戏开始提示
        fmt.Println("\n" + strings.Repeat("=", 30))
        fmt.Println("开始新游戏！")
        fmt.Println(strings.Repeat("=", 30))
    }
}
```

## 6. 游戏体验优化

### 用户界面美化
```go
// displayWelcome 显示欢迎界面
func displayWelcome() {
    fmt.Println(strings.Repeat("=", 50))
    fmt.Println("🎯 Go 语言猜数字游戏")
    fmt.Println(strings.Repeat("=", 50))
    fmt.Println("游戏规则：")
    fmt.Println("• 我会想一个 1-100 之间的数字")
    fmt.Println("• 你需要猜出这个数字")
    fmt.Println("• 我会告诉你猜测是太大还是太小")
    fmt.Println("• 尽量用最少的次数猜中！")
    fmt.Println(strings.Repeat("-", 50))
}

// displayGameStart 显示游戏开始信息
func (g *Game) displayGameStart() {
    fmt.Println("欢迎来到猜数字游戏！")
    fmt.Println("我已经想好了一个 1-100 之间的数字，请开始猜测：")
}

// displayGameEnd 显示游戏结束信息
func (g *Game) displayGameEnd() {
    fmt.Printf("🎉 恭喜你！猜对了！\n")
    fmt.Printf("📊 游戏统计：\n")
    fmt.Printf("   • 猜测次数：%d\n", g.attempts)
    fmt.Printf("   • 目标数字：%d\n", g.targetNumber)
    
    // 根据猜测次数给出评价
    switch {
    case g.attempts <= 3:
        fmt.Println("   • 评价：🏆 太厉害了！")
    case g.attempts <= 6:
        fmt.Println("   • 评价：👍 很不错！")
    case g.attempts <= 10:
        fmt.Println("   • 评价：😊 还可以！")
    default:
        fmt.Println("   • 评价：💪 继续加油！")
    }
}
```

### 输入提示优化
```go
// getPlayerGuessWithHints 带提示的输入获取
func (g *Game) getPlayerGuessWithHints() (int, error) {
    // 显示当前状态
    if g.attempts > 0 {
        fmt.Printf("第 %d 次猜测 ", g.attempts+1)
    }
    fmt.Print("请输入你的猜测 (1-100)：")
    
    if !g.scanner.Scan() {
        return 0, fmt.Errorf("读取输入失败")
    }
    
    input := strings.TrimSpace(g.scanner.Text())
    if input == "" {
        return 0, fmt.Errorf("输入不能为空，请输入一个 1-100 之间的数字")
    }
    
    // 检查是否输入了帮助命令
    if input == "help" || input == "?" {
        g.showHelp()
        return g.getPlayerGuessWithHints() // 递归调用重新获取输入
    }
    
    guess, err := strconv.Atoi(input)
    if err != nil {
        return 0, fmt.Errorf("'%s' 不是有效数字，请输入 1-100 之间的整数", input)
    }
    
    if guess < 1 || guess > 100 {
        return 0, fmt.Errorf("%d 超出范围，请输入 1-100 之间的数字", guess)
    }
    
    return guess, nil
}

// showHelp 显示帮助信息
func (g *Game) showHelp() {
    fmt.Println("\n📖 游戏帮助：")
    fmt.Println("• 输入 1-100 之间的整数")
    fmt.Println("• 根据提示调整下次猜测")
    fmt.Println("• 输入 'help' 或 '?' 查看帮助")
    fmt.Println()
}
```

## 7. 完整的游戏逻辑

```go
// 完整的 Start 方法实现
func (g *Game) Start() {
    g.displayGameStart()
    
    for {
        guess, err := g.getPlayerGuessWithHints()
        if err != nil {
            fmt.Printf("❌ %v\n", err)
            continue
        }
        
        g.attempts++
        result := g.checkGuess(guess)
        
        if result == 0 {
            g.displayGameEnd()
            break
        } else {
            g.provideFeedbackDetailed(guess, result)
        }
    }
}
```

## 8. 实践练习

### 练习1：添加难度级别
```go
type Difficulty int

const (
    Easy   Difficulty = iota // 1-50
    Medium                   // 1-100
    Hard                     // 1-200
)

func (g *Game) SetDifficulty(diff Difficulty) {
    switch diff {
    case Easy:
        g.targetNumber = rand.Intn(50) + 1
    case Medium:
        g.targetNumber = rand.Intn(100) + 1
    case Hard:
        g.targetNumber = rand.Intn(200) + 1
    }
}
```

### 练习2：添加提示功能
```go
func (g *Game) giveHint() {
    if g.attempts >= 5 {
        if g.targetNumber%2 == 0 {
            fmt.Println("💡 提示：目标数字是偶数")
        } else {
            fmt.Println("💡 提示：目标数字是奇数")
        }
    }
}
```

## 小结

本章实现了猜数字游戏的核心逻辑：

1. **随机数生成**：正确设置种子，生成随机目标数字
2. **游戏主循环**：实现完整的游戏流程控制
3. **输入验证**：多层次的输入验证和错误处理
4. **状态管理**：游戏状态的检查和反馈
5. **用户体验**：友好的界面和提示信息

这些核心逻辑构成了一个完整、健壮的猜数字游戏。

## 下一步

继续学习：[05-用户交互与错误处理.md](./05-用户交互与错误处理.md)

在下一章中，我们将深入学习用户交互设计和高级错误处理技巧。
